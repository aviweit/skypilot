apiVersion: v1
kind: Pod
metadata:
  name: sshserver
  labels:
    app: sshserver
spec:
  containers:
  - name: sshserver
    image: ubuntu:latest
    command: ["/bin/sleep", "3650d"]
    imagePullPolicy: IfNotPresent
    lifecycle:
      postStart:
        exec:
          command: ["/bin/bash", "-c", "apt-get update && apt-get install -y openssh-server && mkdir -p ~/.ssh && cp /etc/secret-volume/ssh-publickey ~/.ssh/authorized_keys && service ssh restart"]
    volumeMounts:
    - name: secret-volume
      readOnly: true
      mountPath: "/etc/secret-volume"
  volumes:
   - name: secret-volume
     secret:
       secretName: ssh-key-secret-laptop
  restartPolicy: Always
---
apiVersion: v1
kind: Service
metadata:
  name: sshserver
spec:
  selector:
    app: sshserver
  ports:
  - protocol: TCP
    port: 22
    targetPort: 22
